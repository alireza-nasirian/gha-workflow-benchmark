# Nx Supply-Chain Incident (Aug 2025)

**Workflow exploit → npm token theft → malicious releases**

This package archives the workflow that enabled the incident, plus the downstream publish pipeline, commit history, and a safe demo. Everything here is for defensive analysis and reproducibility.

---

## Summary

**Root cause:**  
A GitHub Actions workflow used `pull_request_target` (elevated permissions on the target repo) and echoed an untrusted PR title into a shell:

```yaml
- name: Validate PR title
  run: |
    echo "Validating PR title: ${{ github.event.pull_request.title }}"
```

**Persistence of risk:**  
Although the workflow was reverted on the main branch, outdated branches still contained it and were exploitable.

**Impact chain:**  
The injected command path was used to trigger `publish.yml`, leading to exfiltration of an npm publish token and the publication of malicious Nx package versions to npm.

---

## What’s in this folder

- **workflows/**
  - `pr-title-validation.yml` — snapshot of the vulnerable workflow.
  - `publish.yml` — redacted snapshot of the publish pipeline present during exploitation.
  - *(Optional)* `versions/` — per-commit snapshots if you include them.
- **commits/**
  - `pr-title-validation.commits.json` — commit history touching the PR-title workflow (time-bounded).
  - `publish.commits.json` — commit history touching the publish pipeline (same window).

---

## Affected versions (as documented)

- **nx:** 20.9.0, 20.10.0, 20.11.0, 20.12.0, 21.5.0, 21.6.0, 21.7.0, 21.8.0  
- **@nx/devkit:** 21.5.0, 20.9.0  
- **@nx/enterprise-cloud:** 3.2.0  
- **@nx/eslint:** 21.5.0  
- **@nx/js:** 21.5.0, 20.9.0  
- **@nx/key:** 3.2.0  
- **@nx/node:** 21.5.0, 20.9.0  
- **@nx/workspace:** 21.5.0, 20.9.0  

---

## Indicators of Compromise (IoCs)

- **Unauthorized repos** in victim accounts: names prefixed with `s1ngularity-repository` (e.g., `s1ngularity-repository-0`, …-1, …) containing a `results.b64` blob.  
- **Local artifacts:** `~/.bashrc` and `~/.zshrc` modified to prepend `sudo shutdown -h 0`; temporary listings at `/tmp/inventory.txt` and `/tmp/inventory.txt.bak`.  
- **Recon/exfil tooling:** attempts to use local developer CLIs (`claude`, `gemini`, `q`) to enumerate interesting files before direct reads and upload.  

---

## Timeline (UTC)

- **2025-08-21** — Vulnerable workflow introduced.  
- **2025-08-22** — Workflow reverted on main; outdated branches still carried it.  
- **2025-08-26** — Malicious Nx versions published to npm.  
- **2025-08-27** — Affected versions removed; credentials rotated; mitigations deployed.  

---

## How to review this package

1. Start with `workflows/pr-title-validation.yml` to see the vulnerable line and trigger.  
2. Open `commits/pr-title-validation.commits.json` to trace introduction and removal.  
3. Inspect `workflows/publish.yml` (redacted) to understand how the token was reachable.  

---

## Defensive notes & mitigations

- Avoid `pull_request_target` unless strictly required. Prefer `pull_request`.  
- Never pass untrusted PR data directly to `run:`. Use parameterized scripts; sanitize inputs.  
- Set explicit, minimal permissions: per job.  
- Require manual approval for workflows from external/first-time contributors.  
- Delete/rebase outdated branches after workflow changes; enforce branch protections.  
- Replace long-lived npm tokens with Trusted Publishers / OIDC for ephemeral credentials.  
- Add static analysis/linting to catch shell-injection patterns.  
- Rotate all secrets after incidents; audit usage of `GITHUB_TOKEN` and repo secrets.  
- Require provenance attestations for published artifacts.  

---

## Disclaimer

This archive is sanitized and for defensive research.  
**Do not run any included workflow against production or public repositories; ensure secrets are disabled in any test environment.**
